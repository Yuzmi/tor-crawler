{% extends "base.html.twig" %}

{% set route = app.request.attributes.get('_route') %}
{% set routeParams = app.request.attributes.get('_route_params')|merge(app.request.query.all) %}

{% block content %}
	<div class="text-center">
		<form class="form-inline" method="get" action="{{ path(route, routeParams) }}">
			<input class="form-control" type="text" name="q" value="{{ q }}" placeholder="onion or title" style="min-width:50%;">
			
			{% set fields = {
				'any': "Any",
				'onion': "Onion",
				'title': "Title"
			} %}
			<select class="form-control" name="qf">
				{% for key,value in fields %}
					<option value="{{ key }}" {{ qf == key ? "selected" }}>
						{{ value }}
					</option>
				{% endfor %}
			</select>

			<button class="btn btn-default" type="submit">Filter</button>
		</form>
	</div>

	<br>

	<div class="text-center">
		{{ pagination.totalItemCount }} result{{ pagination.totalItemCount > 1 ? "s" }}
	</div>

	<br>

	{% set navs = {
		'all': "All",
		'seen': "Seen",
		'unseen': "Never seen"
	} %}
	<ul class="nav nav-tabs nav-justified">
		{% for key,value in navs %}
			<li {% if type == key %}class="active"{% endif %}>
				<a href="{{ path(route, routeParams|merge({'type': key})) }}">
					{{ value }}
				</a>
			</li>
		{% endfor %}
    </ul>

    {% if pagination.count %}
		<div class="table-responsive">
			<table class="table table-striped table-bordered table-condensed">
				{% set ths = {
					'o.hash': "Onion",
					'r.title': "Title",
					'o.dateCreated': "Added",
					'r.dateChecked': "Checked",
					'r.dateSeen': "Seen"
				} %}
				<tr>
					<th></th>
					{% for key,value in ths %}
						<th>
							{{ knp_pagination_sortable(pagination, value, key) }}
							{% if pagination.isSorted(key) %}
								{% if pagination.direction == "asc" %}
									<i class="fa fa-caret-up"></i>
								{% elseif pagination.direction == "desc" %}
									<i class="fa fa-caret-down"></i>
								{% endif %}
							{% endif %}
						</th>
					{% endfor %}
				</tr>
				{% for o in pagination %}
					<tr class="onion" data-onion="{{ o.id }}">
						<td class="text-center">
							<button class="btn btn-default btn-xs more">
								<i class="fa fa-caret-down"></i>
							</button>
						</td>
						<td>{{ o.hash }}</td>
						<td class="title">{{ o.resource ? o.resource.title }}</td>
						<td title="{{ o.dateCreated|date('Y-m-d H:i:s') }}">
							{{ o.dateCreated|date('Y-m-d') }}
						</td>
						<td title="{{ o.resource and o.resource.dateChecked ? o.resource.dateChecked|date('Y-m-d H:i:s') }}">
							{{ o.resource and o.resource.dateChecked ? o.resource.dateChecked|date('Y-m-d') : "Not yet" }}
						</td>
						<td title="{{ o.resource and o.resource.dateSeen ? o.resource.dateSeen|date('Y-m-d H:i:s') }}">
							{{ o.resource and o.resource.dateSeen ? o.resource.dateSeen|date('Y-m-d') : "Never" }}
						</td>
					</tr>
					<tr class="onionDetail-{{ o.id }} hidden">
						<td class="text-center" colspan="6">
							<a class="btn btn-default btn-xs" href="{{ o.url }}"  target="_blank" rel="noopener noreferrer">
								<i class="fa fa-link"></i>
								Direct link
							</a>

							<a class="btn btn-default btn-xs" href="https://{{ o.hash }}.tor2web.ch/" target="_blank" rel="noopener noreferrer">
								<i class="fa fa-link"></i>
								Tor2web
							</a>

							<a class="btn btn-default btn-xs" href="{{ path('check_onion', {'hash': o.hash}) }}" title="Check">
								<i class="fa fa-refresh"></i>
								Check
							</a>
						</td>
					</tr>
				{% endfor %}
			</table>
		</div>

		<div class="text-center">
		    {{ knp_pagination_render(pagination) }}
		</div>
	{% else %}
		<p class="alert alert-info">
			No onion found.
		</p>
	{% endif %}
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		$(document).ready(function() {
			$(".onion button.more").on("click", function() {
				$(".onionDetail-"+$(this).closest(".onion").attr("data-onion")).toggleClass("hidden");
			});
		});
	</script>
{% endblock %}
